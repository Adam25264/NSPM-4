remove all the language in setting english is going to be the main languages put the person prifile instead also in the history a person should know how  many times he had come to late <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NSPM SmartClock - Staff Attendance with Late Payment</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Configuration - ACTIVE -->
    <script>
        // FIREBASE CONFIGURATION - FULLY ACTIVE
        const firebaseConfig = {
            apiKey: "AIzaSyBN0KexNQkEegTvAUA815xJrBqPUa45SOk",
            authDomain: "smarttendance-a355b.firebaseapp.com",
            databaseURL: "https://smarttendance-a355b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "smarttendance-a355b",
            storageBucket: "smarttendance-a355b.firebasestorage.app",
            messagingSenderId: "448589697375",
            appId: "1:448589697375:web:d5b02d378ba9746a68a6ea"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        console.log("üî• FIREBASE INITIALIZED - ACTIVE");
        
        // Set persistence to LOCAL to stay logged in
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => console.log("‚úÖ Firebase persistence set to LOCAL"))
            .catch((error) => console.error("‚ùå Persistence error:", error));
    </script>
    
    <style>
        /* =============================================
           GLOBAL STYLES - MODERN DARK/LIGHT THEME
           ============================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #0056b3;
            --primary-dark: #004494;
            --primary-light: #1a73e8;
            --secondary: #007bff;
            --danger: #dc3545;
            --danger-dark: #bd2130;
            --warning: #ffc107;
            --warning-dark: #e0a800;
            --success: #28a745;
            --success-dark: #1e7e34;
            --late: #ff9800;
            --late-dark: #f57c00;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --card-bg: #1a1a1a;
            --card-border: #333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
        }
        
        body {
            background: var(--dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
            line-height: 1.5;
        }
        
        body.light-mode {
            --primary: #0056b3;
            --primary-dark: #004494;
            --primary-light: #1a73e8;
            --secondary: #007bff;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --late: #ff9800;
            --dark: #f8fafc;
            --darker: #e2e8f0;
            --light: #ffffff;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* =============================================
           AUTHENTICATION STYLES
           ============================================= */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        }
        
        body.light-mode .auth-container {
            background: linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%);
        }
        
        .auth-box {
            background: #2a2a2a;
            width: 100%;
            max-width: 480px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid #333;
            animation: slideIn 0.5s ease;
        }
        
        body.light-mode .auth-box {
            background: #ffffff;
            border: 1px solid #ddd;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 35px 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .auth-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 700;
        }
        
        .auth-header p {
            opacity: 0.95;
            font-size: 15px;
            color: rgba(255,255,255,0.95);
            font-weight: 500;
        }
        
        .auth-body {
            padding: 35px 30px;
        }
        
        .staff-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0, 86, 179, 0.15);
            border-radius: var(--border-radius);
            padding: 15px;
            gap: 12px;
            border: 1px solid var(--primary);
            backdrop-filter: blur(10px);
        }
        
        .staff-badge i {
            font-size: 24px;
            color: var(--primary);
        }
        
        .staff-badge span {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
        }
        
        .form-toggle {
            display: flex;
            margin-bottom: 30px;
            background: var(--darker);
            border-radius: 50px;
            padding: 6px;
            border: 1px solid var(--card-border);
        }
        
        .toggle-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .auth-form {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .auth-form.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon input,
        .input-with-icon select {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid var(--card-border);
            border-radius: var(--border-radius);
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .input-with-icon input:focus,
        .input-with-icon select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            background: var(--card-bg);
        }
        
        .input-with-icon.error input {
            border-color: var(--danger);
        }
        
        .error-message {
            color: var(--danger);
            font-size: 13px;
            margin-top: 8px;
            display: none;
            font-weight: 500;
        }
        
        .btn {
            display: inline-block;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow);
        }
        
        .btn:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: var(--text-muted);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: var(--text-muted);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--late) 0%, var(--late-dark) 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        }
        
        .btn-small {
            padding: 12px 16px;
            font-size: 14px;
        }
        
        .terms {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .terms input {
            margin-right: 12px;
            margin-top: 4px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        
        .terms a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 700;
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 20px;
        }
        
        .forgot-password a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .forgot-password a:hover {
            color: var(--primary);
        }

        /* =============================================
           MAIN APP STYLES
           ============================================= */
        .app-container {
            display: none;
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 90px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--darker) 0%, var(--card-bg) 100%);
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            flex: 1;
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        .staff-info {
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .staff-info span {
            display: block;
            line-height: 1.4;
            font-weight: 600;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }
        
        .theme-toggle:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--card-border);
            display: flex;
            padding: 12px 8px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 5px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: var(--border-radius);
            gap: 6px;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: rgba(0, 123, 255, 0.15);
        }
        
        .nav-item i {
            font-size: 22px;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }

        /* =============================================
           SCANNER STYLES
           ============================================= */
        .scanner-section {
            text-align: center;
        }
        
        .scanner-section h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .scanner-box {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 320px;
            height: 320px;
            margin: 0 auto 20px;
            border: 3px solid var(--card-border);
            border-radius: var(--border-radius);
            overflow: hidden;
            background: #000;
            transition: all 0.3s ease;
        }
        
        .camera-container.camera-active {
            border-color: var(--success);
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: var(--success);
            animation: scan 2s infinite;
            box-shadow: 0 0 15px var(--success);
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        
        .camera-dark-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 25px;
            z-index: 5;
        }
        
        .camera-permission {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 25px;
            text-align: center;
            background: var(--card-bg);
        }
        
        .camera-permission i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .enable-camera-text {
            font-size: 20px;
            font-weight: bold;
            margin: 15px 0;
            line-height: 1.3;
        }
        
        .scanner-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        /* =============================================
           LATE PAYMENT BANNER STYLES
           ============================================= */
        .late-payment-banner {
            background: linear-gradient(135deg, var(--late) 0%, var(--late-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius-lg);
            margin: 20px 0;
            text-align: center;
            box-shadow: var(--shadow-lg);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .late-payment-banner h3 {
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .late-payment-banner .price {
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .late-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: white;
        }

        /* =============================================
           CLOCK BANNER STYLES
           ============================================= */
        .clock-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            margin: 20px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .clock-banner.expired {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
        }
        
        .clock-status {
            display: flex;
            justify-content: space-between;
            margin: 20px 0 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
        }
        
        .clock-status-item {
            text-align: center;
            flex: 1;
        }
        
        .clock-status-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .clock-status-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .clock-status-value.clocked-in {
            color: #a5d6a5;
        }
        
        .clock-status-value.clocked-out {
            color: #ffe082;
        }

        /* =============================================
           HISTORY & TABLE STYLES
           ============================================= */
        .history-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .history-title-section h2 {
            font-size: 24px;
            color: var(--primary);
        }
        
        .history-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            flex: 1;
            min-width: 140px;
            padding: 14px;
            border-radius: var(--border-radius);
            background: var(--darker);
            color: var(--text-primary);
            border: 1px solid var(--card-border);
            font-size: 14px;
            font-weight: 500;
        }
        
        .summary-section {
            margin-bottom: 30px;
        }
        
        .summary-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .summary-table,
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: 14px;
        }
        
        .summary-table th,
        .attendance-table th {
            background: var(--darker);
            color: var(--text-primary);
            font-weight: 700;
            padding: 15px 12px;
            text-align: left;
            border-bottom: 2px solid var(--primary);
        }
        
        .summary-table td,
        .attendance-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--card-border);
            color: var(--text-secondary);
        }
        
        .status-late {
            color: var(--late);
            font-weight: 700;
        }
        
        .status-paid-late {
            color: var(--success);
            font-weight: 700;
        }
        
        .status-on-time {
            color: var(--success);
            font-weight: 700;
        }
        
        .delete-record-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .delete-record-btn:hover {
            background: var(--danger-dark);
            transform: scale(1.05);
        }

        /* =============================================
           MODAL STYLES
           ============================================= */
        .late-payment-modal,
        .new-department-modal,
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .late-payment-content,
        .new-department-content,
        .result-content {
            background: var(--card-bg);
            padding: 35px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            border: 3px solid var(--primary);
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.4s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .late-payment-content {
            border-color: var(--late);
        }
        
        .result-success {
            border-color: var(--success);
        }
        
        .result-error {
            border-color: var(--danger);
        }
        
        .result-icon {
            font-size: 56px;
            margin-bottom: 20px;
        }
        
        .paystack-button {
            background: #00A859;
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }
        
        .paystack-button:hover {
            background: #008F4C;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .paystack-button.warning {
            background: var(--late);
        }
        
        .paystack-button.warning:hover {
            background: var(--late-dark);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        /* =============================================
           LOADING OVERLAY
           ============================================= */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.1);
            border-top: 6px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =============================================
           RESPONSIVE STYLES
           ============================================= */
        @media (max-width: 480px) {
            .header h1 { font-size: 20px; }
            .camera-container { height: 280px; }
            .history-filters { flex-direction: column; }
            .filter-select { min-width: 100%; }
            .auth-header h1 { font-size: 28px; }
            .auth-body { padding: 25px 20px; }
            .late-payment-banner .price { font-size: 32px; }
            .summary-table th,
            .summary-table td,
            .attendance-table th,
            .attendance-table td { 
                padding: 12px 8px; 
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- =============================================
         AUTHENTICATION SECTION - ACTIVE
         ============================================= -->
    <div id="authSection" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1><i class="fas fa-building"></i> NSPM SmartClock</h1>
                <p>Staff Attendance & Late Payment System</p>
                <p style="font-size: 13px; margin-top: 10px; opacity: 0.9;">‚ö° ACTIVE - Ready for use</p>
            </div>
            
            <div class="auth-body">
                <div class="staff-badge">
                    <i class="fas fa-id-card"></i>
                    <span>Staff Portal</span>
                </div>
                
                <div class="form-toggle">
                    <button class="toggle-btn active" id="loginToggle">Login</button>
                    <button class="toggle-btn" id="signupToggle">Register</button>
                </div>
                
                <!-- LOGIN FORM -->
                <form id="loginForm" class="auth-form active">
                    <div class="form-group">
                        <label for="loginId">Staff ID</label>
                        <div class="input-with-icon">
                            <input type="text" id="loginId" placeholder="Enter your staff ID" value="NSPM/IT/001">
                        </div>
                        <div class="error-message" id="loginIdError">Please enter a valid staff ID</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <div class="input-with-icon">
                            <input type="password" id="loginPassword" placeholder="Enter your password" value="Password123!">
                        </div>
                        <div class="error-message" id="loginPasswordError">Please enter your password</div>
                    </div>
                    
                    <div class="terms">
                        <input type="checkbox" id="rememberMe" checked>
                        <label for="rememberMe">Remember me for 30 days</label>
                    </div>
                    
                    <button type="submit" class="btn" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i> Login to Portal
                    </button>

                    <div class="forgot-password">
                        <a href="#" id="forgotPasswordLink">Forgot password?</a>
                    </div>
                    
                    <div class="clear-cache-link" id="clearCacheLinkContainer">
                        <a href="#" id="clearCacheLink" style="color: var(--warning);">Clear cache & reset</a>
                    </div>
                </form>
                
                <!-- REGISTER FORM -->
                <form id="signupForm" class="auth-form">
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <div class="input-with-icon">
                            <input type="text" id="fullName" placeholder="Enter your full name">
                        </div>
                        <div class="error-message" id="fullNameError">Please enter your full name</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Official Email</label>
                        <div class="input-with-icon">
                            <input type="email" id="email" placeholder="you@nspm.gov.ng">
                        </div>
                        <div class="error-message" id="emailError">Please enter a valid email</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="userId">Staff ID</label>
                        <div class="input-with-icon">
                            <input type="text" id="userId" placeholder="e.g., NSPM/IT/001">
                        </div>
                        <div class="error-message" id="userIdError">Please enter a valid staff ID</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="department">Department</label>
                        <div class="input-with-icon">
                            <select id="department">
                                <option value="">Select Department</option>
                                <option value="IT">Information Technology</option>
                                <option value="HR">Human Resources</option>
                                <option value="FIN">Finance</option>
                                <option value="OPS">Operations</option>
                                <option value="ADMIN">Administration</option>
                                <option value="PROD">Production</option>
                                <option value="QA">Quality Assurance</option>
                            </select>
                        </div>
                        <div class="error-message" id="departmentError">Please select your department</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="designation">Designation</label>
                        <div class="input-with-icon">
                            <input type="text" id="designation" placeholder="e.g., Senior Developer">
                        </div>
                        <div class="error-message" id="designationError">Please enter your designation</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <div class="input-with-icon">
                            <input type="password" id="signupPassword" placeholder="Create a strong password">
                        </div>
                        <div class="error-message" id="signupPasswordError">Password must meet requirements</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <div class="input-with-icon">
                            <input type="password" id="confirmPassword" placeholder="Confirm your password">
                        </div>
                        <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
                    </div>
                    
                    <div class="terms">
                        <input type="checkbox" id="agreeTerms">
                        <label for="agreeTerms">I agree to the <a href="#">Terms</a> and <a href="#">Privacy Policy</a></label>
                    </div>
                    <div class="error-message" id="termsError">You must agree to the terms</div>
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-user-plus"></i> Register Staff Account
                    </button>
                </form>
                
                <!-- FORGOT PASSWORD FORM -->
                <form id="forgotPasswordForm" class="auth-form">
                    <div class="form-group">
                        <label for="forgotEmail">Official Email</label>
                        <div class="input-with-icon">
                            <input type="email" id="forgotEmail" placeholder="Enter your official email">
                        </div>
                        <div class="error-message" id="forgotEmailError">Please enter a valid email</div>
                    </div>
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-key"></i> Send Reset Instructions
                    </button>

                    <div class="forgot-password">
                        <a href="#" id="backToLoginLink">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- =============================================
         MAIN APPLICATION - ACTIVE
         ============================================= -->
    <div class="app-container" id="mainApp">
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-building"></i> NSPM SmartClock</h1>
                <div class="staff-info" id="staffInfo">
                    <span id="staffName">Loading...</span>
                    <span id="staffId">-</span>
                    <span id="staffDepartment">-</span>
                    <span id="staffDesignation">-</span>
                </div>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
        
        <!-- CLOCK STATUS BANNER -->
        <div id="clockBanner" class="clock-banner">
            <div class="banner-content">
                <h3><i class="fas fa-clock"></i> <span id="clockStatusTitle">Service Required</span></h3>
                <p><span id="clockStatusMessage">Activate your service to begin</span></p>
                <div class="clock-status">
                    <div class="clock-status-item">
                        <div class="clock-status-label">Today</div>
                        <div id="todayStatus" class="clock-status-value">--</div>
                    </div>
                    <div class="clock-status-item">
                        <div class="clock-status-label">Last In</div>
                        <div id="lastClockIn" class="clock-status-value">--:--</div>
                    </div>
                    <div class="clock-status-item">
                        <div class="clock-status-label">Last Out</div>
                        <div id="lastClockOut" class="clock-status-value">--:--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SCANNER TAB -->
        <div id="scanner" class="tab-content active">
            <div class="scanner-section">
                <h2><i class="fas fa-qrcode"></i> Scan QR Code</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Point camera at department QR code</p>
                
                <!-- LATE PAYMENT BANNER - SHOWN WHEN LATE -->
                <div id="latePaymentBanner" class="late-payment-banner" style="display: none;">
                    <i class="fas fa-exclamation-triangle late-icon"></i>
                    <h3>‚ö†Ô∏è YOU ARE LATE</h3>
                    <p style="font-size: 16px; margin-bottom: 10px;">Payment required to clock in</p>
                    <div class="price">‚Ç¶1,000</div>
                    <button class="paystack-button warning" onclick="showLatePaymentModal()">
                        <i class="fas fa-credit-card"></i> Pay ‚Ç¶1,000 Now
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="cancelLateAttendance()" style="margin-top: 15px;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
                
                <div class="scanner-box">
                    <div class="camera-container" id="cameraContainer">
                        <div id="cameraDarkOverlay" class="camera-dark-overlay">
                            <i class="fas fa-camera"></i>
                            <h3>Camera Ready</h3>
                            <p>Click Start Scanner to begin</p>
                        </div>
                        <video id="video" playsinline autoplay></video>
                        <div class="scan-overlay">
                            <div class="scan-line"></div>
                        </div>
                        <div id="scannerDisabled" class="scanner-disabled" style="display: none;">
                            <i class="fas fa-lock"></i>
                            <h3>Scanner Locked</h3>
                            <p>Please activate service to scan</p>
                            <button class="btn btn-warning" onclick="switchTab('payment')">
                                Activate Now
                            </button>
                        </div>
                        <div id="cameraPermission" class="camera-permission" style="display: none;">
                            <i class="fas fa-video-slash"></i>
                            <h3>Camera Access Required</h3>
                            <p>Please enable camera access</p>
                            <button class="btn" onclick="startScanner()">Enable Camera</button>
                        </div>
                    </div>
                    
                    <div class="scanner-controls">
                        <button class="btn" onclick="startScanner()" id="startBtn">
                            <i class="fas fa-play"></i> Start Scanner
                        </button>
                        <button class="btn btn-danger" onclick="stopScanner()" id="stopBtn" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Scanner
                        </button>
                    </div>
                </div>
                
                <div style="color: var(--text-muted); font-size: 12px; margin-top: 15px;">
                    <i class="fas fa-info-circle"></i> Staff who arrive after 9:00 AM must pay ‚Ç¶1,000
                </div>
            </div>
        </div>
        
        <!-- HISTORY TAB -->
        <div id="history" class="tab-content">
            <div class="history-header">
                <div class="history-title-section">
                    <h2><i class="fas fa-history"></i> Attendance History</h2>
                </div>
                <p style="color: var(--text-secondary);">Complete attendance record with late payments</p>
                
                <div class="history-filters">
                    <input type="date" id="dateFilter" class="filter-select">
                    <select id="typeFilter" class="filter-select" onchange="filterAttendanceHistory()">
                        <option value="">All Types</option>
                        <option value="clock_in">Clock In</option>
                        <option value="clock_out">Clock Out</option>
                    </select>
                    <select id="lateFilter" class="filter-select" onchange="filterAttendanceHistory()">
                        <option value="">All Status</option>
                        <option value="on_time">On Time</option>
                        <option value="late">Late (Paid)</option>
                    </select>
                </div>
            </div>
            
            <div class="summary-section">
                <h3><i class="fas fa-chart-bar"></i> Daily Summary</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Clock In</th>
                            <th>Clock Out</th>
                            <th>Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="attendance-table-container">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-list"></i> Detailed Records</h3>
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Time</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Payment Ref</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- PAYMENT TAB -->
        <div id="payment" class="tab-content">
            <h2><i class="fas fa-credit-card"></i> Service Activation</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Activate monthly attendance service</p>
            
            <div class="subscription-card" style="background: var(--card-bg); border-radius: var(--border-radius-lg); padding: 25px; border: 1px solid var(--card-border);">
                <h3 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-id-card"></i> Current Status</h3>
                
                <div class="subscription-info">
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                        <span>Service:</span>
                        <span><strong>NSPM Attendance System</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                        <span>Price:</span>
                        <span><strong style="color: var(--success);">‚Ç¶1,000 / Month</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                        <span>Status:</span>
                        <span id="subscriptionStatus" style="color: var(--warning);"><strong id="statusValue">Not Active</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                        <span>Expires:</span>
                        <span id="subscriptionExpiry"><strong id="expiresValue">--/--/----</strong></span>
                    </div>
                </div>
                
                <h4 style="margin: 25px 0 15px;">Payment Method</h4>
                <div class="payment-option" onclick="showPaymentForm('paystack')" style="display: flex; align-items: center; padding: 18px; background: var(--darker); border-radius: var(--border-radius); cursor: pointer; border: 1px solid var(--card-border); transition: all 0.3s;">
                    <div style="margin-right: 15px;"><i class="fas fa-university" style="font-size: 24px; color: var(--primary);"></i></div>
                    <div>
                        <div><strong>Pay with Paystack</strong></div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Cards, Bank Transfer, USSD</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="settings-section">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Account & app preferences</p>
                
                <div class="settings-card" style="background: var(--card-bg); border-radius: var(--border-radius-lg); padding: 25px;">
                    <div class="settings-group">
                        <h3 style="color: var(--primary); margin-bottom: 20px;">Account Information</h3>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                            <span>Staff ID:</span>
                            <span id="settingsStaffId" style="font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                            <span>Department:</span>
                            <span id="settingsDepartment">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                            <span>Designation:</span>
                            <span id="settingsDesignation">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                            <span>Service Status:</span>
                            <span id="settingsServiceStatus" style="color: var(--warning); font-weight: 700;">Inactive</span>
                        </div>
                    </div>
                    
                    <div class="logout-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--card-border);">
                        <h3 style="margin-bottom: 15px;">Account</h3>
                        <button class="btn btn-danger" onclick="logout()" style="width: 100%;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav" id="bottomNav">
        <button class="nav-item active" onclick="switchTab('scanner')">
            <i class="fas fa-qrcode"></i>
            <span class="nav-label">Scan</span>
        </button>
        <button class="nav-item" onclick="switchTab('history')">
            <i class="fas fa-history"></i>
            <span class="nav-label">History</span>
        </button>
        <button class="nav-item" onclick="switchTab('payment')">
            <i class="fas fa-credit-card"></i>
            <span class="nav-label">Pay</span>
        </button>
        <button class="nav-item" onclick="switchTab('settings')">
            <i class="fas fa-cog"></i>
            <span class="nav-label">Settings</span>
        </button>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingMessage" style="font-size: 18px;">Processing...</p>
    </div>

    <!-- RESULT MODAL -->
    <div id="resultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px;">
        <div id="resultContent" style="background: var(--card-bg); padding: 35px; border-radius: var(--border-radius-lg); text-align: center; max-width: 380px; width: 100%; border: 3px solid var(--primary);">
            <div id="resultIcon" style="font-size: 56px; margin-bottom: 20px;"></div>
            <h3 id="resultTitle" style="font-size: 24px; margin-bottom: 15px;">Success</h3>
            <p id="resultMessage" style="margin-bottom: 25px; line-height: 1.6;"></p>
            <button class="btn" onclick="closeResult()">Continue</button>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; padding: 20px;">
        <div style="background: var(--card-bg); padding: 35px; border-radius: var(--border-radius-lg); max-width: 400px; width: 100%; border: 3px solid var(--primary);">
            <h2 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-credit-card"></i> Activate Service</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">Pay ‚Ç¶1,000 for 1 month access</p>
            
            <div id="paystackPaymentForm">
                <div class="form-group">
                    <label for="paystackEmail">Email Address</label>
                    <input type="email" id="paystackEmail" placeholder="your@email.com" style="width: 100%; padding: 14px; border-radius: var(--border-radius); background: var(--darker); color: var(--text-primary); border: 1px solid var(--card-border);">
                </div>
                
                <button class="paystack-button" onclick="processPaystackPayment()">
                    <i class="fas fa-lock"></i> Pay ‚Ç¶1,000 with Paystack
                </button>
            </div>
            
            <div style="margin: 25px 0; padding: 15px; background: var(--darker); border-radius: var(--border-radius);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Service:</span>
                    <span><strong>Attendance System</strong></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Amount:</span>
                    <span><strong style="color: var(--success);">‚Ç¶1,000 NGN</strong></span>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closePaymentModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- LATE PAYMENT MODAL -->
    <div id="latePaymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; padding: 20px;">
        <div style="background: var(--card-bg); padding: 35px; border-radius: var(--border-radius-lg); max-width: 400px; width: 100%; border: 3px solid var(--late);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--late); margin-bottom: 15px;"></i>
            <h2 style="color: var(--late); margin-bottom: 15px;">Late Attendance</h2>
            <p style="margin-bottom: 10px;">You are clocking in after 9:00 AM</p>
            <div style="font-size: 36px; font-weight: 800; color: var(--late); margin: 20px 0;">‚Ç¶1,000</div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="latePaymentEmail">Email Address</label>
                <input type="email" id="latePaymentEmail" placeholder="your@email.com" style="width: 100%; padding: 14px; border-radius: var(--border-radius); background: var(--darker); color: var(--text-primary); border: 1px solid var(--late);">
            </div>
            
            <button class="paystack-button warning" onclick="processLatePayment()" style="width: 100%;">
                <i class="fas fa-credit-card"></i> Pay ‚Ç¶1,000 Now
            </button>
            
            <button class="btn btn-secondary" onclick="closeLatePaymentModal()" style="width: 100%; margin-top: 15px;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // =============================================
        // NSPM SMARTCLOCK - FULLY ACTIVE SYSTEM
        // STAFF ATTENDANCE WITH LATE PAYMENT (‚Ç¶1,000)
        // =============================================
        
        // =============================================
        // GLOBAL STATE & CONFIGURATION
        // =============================================
        const APP_VERSION = '2.0.0';
        const LATE_THRESHOLD_HOUR = 9;      // 9:00 AM late threshold
        const LATE_THRESHOLD_MINUTE = 0;     // 00 minutes
        const LATE_PAYMENT_AMOUNT = 1000;    // ‚Ç¶1,000 for late attendance
        const SUBSCRIPTION_PRICE = 1000;     // ‚Ç¶1,000 per month
        const PAYSTACK_PUBLIC_KEY = 'pk_live_54247d3182c251b3d9509ef2bff79157e3061edb';
        
        // Application state
        let currentUser = null;
        let users = [];
        let attendanceRecords = [];
        let videoStream = null;
        let scanInterval = null;
        let isScannerActive = false;
        let scanCooldown = false;
        let lastScannedCode = null;
        let pendingLateScanData = null;
        let currentPaymentMethod = null;
        
        // =============================================
        // INITIALIZATION - RUNS IMMEDIATELY
        // =============================================
        (function initializeSystem() {
            console.log("üöÄ NSPM SmartClock - INITIALIZING ACTIVE SYSTEM");
            
            // Load or create demo users
            loadUsers();
            
            // Set up Firebase auth listener
            setupFirebaseAuthListener();
            
            // Check for saved session
            const savedUser = localStorage.getItem('nspm_currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log("‚úÖ Restored user session:", currentUser.name);
                    
                    // Verify with Firebase
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            showMainApp();
                            initializeMainApp();
                        } else {
                            // Firebase session expired, but we have local user
                            console.log("‚ö†Ô∏è Firebase session expired, using local session");
                            showMainApp();
                            initializeMainApp();
                        }
                    });
                } catch (e) {
                    console.error("Failed to restore session:", e);
                    showAuth();
                }
            } else {
                showAuth();
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Set today's date in filter
            const today = new Date().toISOString().split('T')[0];
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) dateFilter.value = today;
            
            console.log("‚úÖ System initialized - READY");
        })();
        
        // =============================================
        // USER MANAGEMENT - ACTIVE
        // =============================================
        function loadUsers() {
            const savedUsers = localStorage.getItem('nspm_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
                console.log(`üìã Loaded ${users.length} users from storage`);
            } else {
                // Create demo users for immediate use
                users = [
                    {
                        id: 'STAFF1001',
                        name: 'John Smith',
                        email: 'john.smith@nspm.gov.ng',
                        password: 'Password123!',
                        userId: 'NSPM/IT/001',
                        department: 'IT',
                        designation: 'Senior Developer',
                        role: 'staff',
                        subscription: {
                            type: 'active',
                            status: 'active',
                            expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                            lastPaymentDate: new Date().toISOString()
                        }
                    },
                    {
                        id: 'STAFF1002',
                        name: 'Sarah Johnson',
                        email: 'sarah.johnson@nspm.gov.ng',
                        password: 'Password123!',
                        userId: 'NSPM/HR/002',
                        department: 'HR',
                        designation: 'HR Manager',
                        role: 'staff',
                        subscription: {
                            type: 'active',
                            status: 'active',
                            expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                            lastPaymentDate: new Date().toISOString()
                        }
                    }
                ];
                localStorage.setItem('nspm_users', JSON.stringify(users));
                console.log("‚úÖ Created demo users for immediate use");
            }
        }
        
        // =============================================
        // FIREBASE AUTHENTICATION - ACTIVE
        // =============================================
        function setupFirebaseAuthListener() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log("üî• Firebase: User authenticated", user.uid);
                } else {
                    console.log("üî• Firebase: No authenticated user");
                }
            });
        }
        
        async function handleFirebaseLogin(staffId, password) {
            try {
                const cleanEmail = staffId.replace(/\//g, '.') + '@nspm.gov.ng';
                const userCredential = await firebase.auth().signInWithEmailAndPassword(cleanEmail, password);
                console.log("‚úÖ Firebase login successful:", userCredential.user.uid);
                return userCredential.user;
            } catch (error) {
                console.log("‚ö†Ô∏è Firebase login failed, using local auth:", error.code);
                // Fall back to local authentication
                return null;
            }
        }
        
        // =============================================
        // AUTHENTICATION UI & LOGIC
        // =============================================
        function showAuth() {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('bottomNav').style.display = 'none';
        }
        
        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'flex';
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('signupForm').classList.remove('active');
            document.getElementById('forgotPasswordForm').classList.remove('active');
            document.getElementById('loginToggle').classList.add('active');
            document.getElementById('signupToggle').classList.remove('active');
        }
        
        function showSignupForm() {
            document.getElementById('signupForm').classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('forgotPasswordForm').classList.remove('active');
            document.getElementById('signupToggle').classList.add('active');
            document.getElementById('loginToggle').classList.remove('active');
        }
        
        function showForgotPasswordForm() {
            document.getElementById('forgotPasswordForm').classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('signupForm').classList.remove('active');
            document.getElementById('loginToggle').classList.remove('active');
            document.getElementById('signupToggle').classList.remove('active');
        }
        
        // =============================================
        // LOGIN HANDLER - ACTIVE
        // =============================================
        async function handleLogin() {
            const staffId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!staffId || !password) {
                showResult('error', 'Login Failed', 'Please enter your staff ID and password');
                return;
            }
            
            showLoading('Signing in...');
            
            try {
                // Try Firebase first
                await handleFirebaseLogin(staffId, password);
                
                // Find user in local storage
                const user = users.find(u => u.userId === staffId && u.password === password);
                
                if (user) {
                    // Login successful
                    currentUser = { ...user };
                    delete currentUser.password; // Don't store password
                    
                    // Save session
                    localStorage.setItem('nspm_currentUser', JSON.stringify(currentUser));
                    
                    hideLoading();
                    showMainApp();
                    initializeMainApp();
                    
                    showResult('success', 'Welcome Back!', 
                        `Successfully logged in as ${user.name}<br>${user.department} - ${user.designation}`);
                } else {
                    hideLoading();
                    showResult('error', 'Login Failed', 'Invalid staff ID or password. Try: NSPM/IT/001 / Password123!');
                }
            } catch (error) {
                hideLoading();
                showResult('error', 'Login Failed', 'Unable to login. Please check your credentials.');
            }
        }
        
        // =============================================
        // SIGNUP HANDLER - ACTIVE
        // =============================================
        async function handleSignup() {
            const name = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const userId = document.getElementById('userId').value;
            const department = document.getElementById('department').value;
            const designation = document.getElementById('designation').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            // Validation
            if (!name || !email || !userId || !department || !designation || !password) {
                showResult('error', 'Registration Failed', 'Please fill in all required fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showResult('error', 'Registration Failed', 'Passwords do not match');
                return;
            }
            
            if (!agreeTerms) {
                showResult('error', 'Registration Failed', 'You must agree to the terms and conditions');
                return;
            }
            
            showLoading('Creating your account...');
            
            try {
                // Create new user
                const newUser = {
                    id: 'STAFF' + (users.length + 1001),
                    name: name,
                    email: email,
                    password: password,
                    userId: userId,
                    department: department,
                    designation: designation,
                    role: 'staff',
                    subscription: {
                        type: 'active',
                        status: 'active',
                        expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days free trial
                        lastPaymentDate: new Date().toISOString()
                    }
                };
                
                users.push(newUser);
                localStorage.setItem('nspm_users', JSON.stringify(users));
                
                // Try Firebase signup
                try {
                    const cleanEmail = userId.replace(/\//g, '.') + '@nspm.gov.ng';
                    await firebase.auth().createUserWithEmailAndPassword(cleanEmail, password);
                } catch (fbError) {
                    console.log("Firebase signup optional:", fbError.code);
                }
                
                // Auto login
                currentUser = { ...newUser };
                delete currentUser.password;
                localStorage.setItem('nspm_currentUser', JSON.stringify(currentUser));
                
                hideLoading();
                showMainApp();
                initializeMainApp();
                
                showResult('success', 'Account Created!', 
                    'Your staff account has been created successfully.<br>You now have a 30-day free trial!');
                
            } catch (error) {
                hideLoading();
                showResult('error', 'Registration Failed', 'Unable to create account. Please try again.');
            }
        }
        
        // =============================================
        // MAIN APP INITIALIZATION
        // =============================================
        function initializeMainApp() {
            if (!currentUser) return;
            
            console.log("üöÄ Initializing main app for:", currentUser.name);
            
            // Update UI with user info
            document.getElementById('staffName').textContent = currentUser.name;
            document.getElementById('staffId').textContent = currentUser.userId;
            document.getElementById('staffDepartment').textContent = currentUser.department;
            document.getElementById('staffDesignation').textContent = currentUser.designation;
            
            // Settings page
            document.getElementById('settingsStaffId').textContent = currentUser.userId;
            document.getElementById('settingsDepartment').textContent = currentUser.department;
            document.getElementById('settingsDesignation').textContent = currentUser.designation;
            
            // Load attendance records
            loadAttendanceRecords();
            
            // Update service status
            updateServiceStatus();
            
            // Enable scanner if service is active
            enableScanner();
            
            console.log("‚úÖ Main app initialized");
        }
        
        // =============================================
        // ATTENDANCE RECORDS MANAGEMENT
        // =============================================
        function loadAttendanceRecords() {
            if (!currentUser) return;
            
            const key = `attendance_${currentUser.id}`;
            const saved = localStorage.getItem(key);
            
            if (saved) {
                attendanceRecords = JSON.parse(saved);
                console.log(`üìä Loaded ${attendanceRecords.length} attendance records`);
            } else {
                // Create demo attendance records
                attendanceRecords = generateDemoRecords();
                localStorage.setItem(key, JSON.stringify(attendanceRecords));
            }
            
            // Update UI
            loadAttendanceHistory();
            generateSummaryTable();
            updateTodayStatus();
        }
        
        function generateDemoRecords() {
            const records = [];
            const today = new Date();
            
            // Generate records for the last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Random clock in time (8:45 - 9:15)
                const clockInHour = 8 + Math.floor(Math.random() * 2);
                const clockInMinute = Math.floor(Math.random() * 30);
                const isLate = clockInHour > 9 || (clockInHour === 9 && clockInMinute > 0);
                
                // Clock out time (17:00 - 18:00)
                const clockOutHour = 17 + Math.floor(Math.random() * 2);
                const clockOutMinute = Math.floor(Math.random() * 60);
                
                const clockInTime = `${clockInHour.toString().padStart(2, '0')}:${clockInMinute.toString().padStart(2, '0')}`;
                const clockOutTime = `${clockOutHour.toString().padStart(2, '0')}:${clockOutMinute.toString().padStart(2, '0')}`;
                
                // Clock in record
                records.push({
                    id: `demo_in_${i}`,
                    staffId: currentUser.userId,
                    staffName: currentUser.name,
                    department: currentUser.department,
                    location: 'Main Office',
                    type: 'clock_in',
                    date: dateStr,
                    time: clockInTime,
                    timestamp: new Date(`${dateStr}T${clockInTime}`).getTime(),
                    status: isLate ? 'late' : 'on_time',
                    latePayment: isLate ? {
                        paid: true,
                        amount: 1000,
                        paymentReference: 'LATE-DEMO-' + Date.now(),
                        paymentDate: new Date().toISOString()
                    } : null
                });
                
                // Clock out record
                records.push({
                    id: `demo_out_${i}`,
                    staffId: currentUser.userId,
                    staffName: currentUser.name,
                    department: currentUser.department,
                    location: 'Main Office',
                    type: 'clock_out',
                    date: dateStr,
                    time: clockOutTime,
                    timestamp: new Date(`${dateStr}T${clockOutTime}`).getTime()
                });
            }
            
            return records;
        }
        
        function saveAttendanceRecords() {
            if (!currentUser) return;
            const key = `attendance_${currentUser.id}`;
            localStorage.setItem(key, JSON.stringify(attendanceRecords));
        }
        
        // =============================================
        // SERVICE STATUS MANAGEMENT
        // =============================================
        function checkServiceStatus() {
            if (!currentUser || !currentUser.subscription) {
                return { isValid: false, isActive: false, daysLeft: 0 };
            }
            
            const expiryDate = new Date(currentUser.subscription.expiry);
            const today = new Date();
            const timeDiff = expiryDate - today;
            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            
            return {
                isValid: daysLeft > 0,
                isActive: currentUser.subscription.status === 'active',
                daysLeft: daysLeft,
                expiryDate: expiryDate
            };
        }
        
        function updateServiceStatus() {
            const status = checkServiceStatus();
            const clockBanner = document.getElementById('clockBanner');
            
            if (status.isValid && status.isActive) {
                // Service active
                clockBanner.style.display = 'block';
                clockBanner.classList.remove('expired');
                document.getElementById('clockStatusTitle').textContent = '‚úÖ Service Active';
                document.getElementById('clockStatusMessage').textContent = `${status.daysLeft} days remaining`;
                
                // Update payment tab
                document.getElementById('statusValue').textContent = `Active (${status.daysLeft} days)`;
                document.getElementById('subscriptionStatus').style.color = 'var(--success)';
                document.getElementById('expiresValue').textContent = formatDate(status.expiryDate);
                document.getElementById('settingsServiceStatus').textContent = 'Active';
                document.getElementById('settingsServiceStatus').style.color = 'var(--success)';
                
                enableScanner();
            } else {
                // Service inactive or expired
                clockBanner.style.display = 'block';
                clockBanner.classList.add('expired');
                document.getElementById('clockStatusTitle').textContent = '‚ùå Service Required';
                document.getElementById('clockStatusMessage').textContent = 'Activate service to continue';
                
                document.getElementById('statusValue').textContent = 'Not Active';
                document.getElementById('subscriptionStatus').style.color = 'var(--warning)';
                document.getElementById('expiresValue').textContent = '--/--/----';
                document.getElementById('settingsServiceStatus').textContent = 'Inactive';
                document.getElementById('settingsServiceStatus').style.color = 'var(--warning)';
                
                disableScanner();
            }
        }
        
        function enableScanner() {
            const status = checkServiceStatus();
            if (status.isValid && status.isActive) {
                document.getElementById('scannerDisabled').style.display = 'none';
                document.getElementById('startBtn').style.display = 'block';
            }
        }
        
        function disableScanner() {
            document.getElementById('scannerDisabled').style.display = 'flex';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            stopScanner();
        }
        
        function canUserScan() {
            const status = checkServiceStatus();
            return status.isValid && status.isActive;
        }
        
        // =============================================
        // LATE ATTENDANCE DETECTION
        // =============================================
        function isUserLate() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // After 9:00 AM is late
            return hours > LATE_THRESHOLD_HOUR || 
                   (hours === LATE_THRESHOLD_HOUR && minutes > LATE_THRESHOLD_MINUTE);
        }
        
        // =============================================
        // SCANNER FUNCTIONS - ACTIVE
        // =============================================
        async function startScanner() {
            if (isScannerActive) return;
            
            if (!canUserScan()) {
                showResult('error', 'Service Required', 'Please activate your service to use the scanner');
                switchTab('payment');
                return;
            }
            
            const video = document.getElementById('video');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                
                video.onloadedmetadata = function() {
                    video.play();
                    document.getElementById('cameraDarkOverlay').style.display = 'none';
                    video.style.display = 'block';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                    document.querySelector('.camera-container').classList.add('camera-active');
                    
                    scanInterval = setInterval(scanQRCode, 300);
                    isScannerActive = true;
                    console.log("‚úÖ Scanner started");
                };
                
            } catch (err) {
                console.error('Camera error:', err);
                document.getElementById('cameraPermission').style.display = 'flex';
                showResult('error', 'Camera Access', 'Please allow camera access to scan QR codes');
            }
        }
        
        function stopScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            const video = document.getElementById('video');
            video.style.display = 'none';
            video.srcObject = null;
            
            document.getElementById('cameraDarkOverlay').style.display = 'flex';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.querySelector('.camera-container').classList.remove('camera-active');
            
            isScannerActive = false;
            scanCooldown = false;
            lastScannedCode = null;
            
            console.log("üõë Scanner stopped");
        }
        
        function scanQRCode() {
            const video = document.getElementById('video');
            
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA || !isScannerActive || scanCooldown) {
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                
                if (code && code.data !== lastScannedCode) {
                    console.log("üì± QR Code detected:", code.data);
                    scanCooldown = true;
                    lastScannedCode = code.data;
                    processQRCode(code.data);
                    
                    setTimeout(() => {
                        stopScanner();
                    }, 1000);
                }
            } catch (err) {
                console.error('QR scan error:', err);
            }
        }
        
        // =============================================
        // QR CODE PROCESSING - ACTIVE
        // =============================================
        async function processQRCode(qrData) {
            try {
                let data;
                try {
                    data = JSON.parse(qrData);
                } catch {
                    // If not JSON, create a default QR data
                    data = {
                        locationId: 'MAIN-001',
                        department: currentUser.department,
                        locationName: 'Main Office'
                    };
                }
                
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                
                // Check if already clocked in today
                const todayRecords = attendanceRecords.filter(r => 
                    r.staffId === currentUser.userId && r.date === today
                );
                
                const hasClockIn = todayRecords.some(r => r.type === 'clock_in');
                const hasClockOut = todayRecords.some(r => r.type === 'clock_out');
                
                if (hasClockIn && hasClockOut) {
                    showResult('error', 'Already Completed', 'You have already completed your attendance for today');
                    scanCooldown = false;
                    lastScannedCode = null;
                    return;
                }
                
                let recordType = !hasClockIn ? 'clock_in' : 'clock_out';
                
                // FOR CLOCK IN - Check if late
                if (recordType === 'clock_in' && isUserLate()) {
                    console.log("‚ö†Ô∏è Late attendance detected - requiring payment");
                    
                    // Store scan data for after payment
                    pendingLateScanData = qrData;
                    
                    // Stop scanner and show late payment banner
                    stopScanner();
                    document.getElementById('latePaymentBanner').style.display = 'block';
                    
                    showResult('warning', '‚ö†Ô∏è You Are Late', 
                        'You are clocking in after 9:00 AM.<br>A payment of ‚Ç¶1,000 is required.');
                    
                    return;
                }
                
                // Process normal attendance (on time clock in or clock out)
                await recordAttendance(data, recordType);
                
            } catch (error) {
                console.error('QR processing error:', error);
                showResult('error', 'Scan Failed', 'Unable to process QR code. Please try again.');
                scanCooldown = false;
                lastScannedCode = null;
            }
        }
        
        async function recordAttendance(qrData, recordType) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            
            const record = {
                id: `att_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                staffId: currentUser.userId,
                staffName: currentUser.name,
                department: currentUser.department,
                location: qrData.locationName || 'Main Office',
                locationId: qrData.locationId || 'MAIN-001',
                type: recordType,
                date: today,
                time: timeStr,
                timestamp: now.getTime(),
                status: recordType === 'clock_in' ? 'on_time' : undefined
            };
            
            // Save to Firebase
            try {
                await firebase.database()
                    .ref(`attendance/${today}/${record.id}`)
                    .set(record);
                console.log("‚úÖ Saved to Firebase");
            } catch (fbError) {
                console.log("Firebase save optional:", fbError.message);
            }
            
            // Save locally
            attendanceRecords.unshift(record);
            saveAttendanceRecords();
            
            // Update UI
            loadAttendanceHistory();
            generateSummaryTable();
            updateTodayStatus();
            
            // Show success message
            const action = recordType === 'clock_in' ? 'Clocked In' : 'Clocked Out';
            const emoji = recordType === 'clock_in' ? '‚úÖ' : 'üîÑ';
            
            showResult('success', `${emoji} ${action}`, 
                `Successfully ${recordType === 'clock_in' ? 'clocked in' : 'clocked out'}<br>
                 Time: ${formatTime(now)}<br>
                 Location: ${record.location}`);
        }
        
        // =============================================
        // LATE PAYMENT PROCESSING - ACTIVE
        // =============================================
        function showLatePaymentModal() {
            if (currentUser && currentUser.email) {
                document.getElementById('latePaymentEmail').value = currentUser.email;
            }
            document.getElementById('latePaymentModal').style.display = 'flex';
        }
        
        function closeLatePaymentModal() {
            document.getElementById('latePaymentModal').style.display = 'none';
        }
        
        function cancelLateAttendance() {
            document.getElementById('latePaymentBanner').style.display = 'none';
            pendingLateScanData = null;
            enableScanner();
        }
        
        async function processLatePayment() {
            const email = document.getElementById('latePaymentEmail').value.trim();
            
            if (!email) {
                showResult('error', 'Email Required', 'Please enter your email address');
                return;
            }
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showResult('error', 'Invalid Email', 'Please enter a valid email address');
                return;
            }
            
            if (!pendingLateScanData) {
                showResult('error', 'No Scan Data', 'Please scan the QR code again');
                closeLatePaymentModal();
                return;
            }
            
            showLoading('Opening Paystack...');
            
            try {
                const reference = 'LATE-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8);
                
                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: email,
                    amount: LATE_PAYMENT_AMOUNT * 100,
                    currency: 'NGN',
                    ref: reference,
                    metadata: {
                        staffId: currentUser.userId,
                        staffName: currentUser.name,
                        paymentType: 'late_attendance',
                        timestamp: new Date().toISOString()
                    },
                    callback: function(response) {
                        hideLoading();
                        console.log("‚úÖ Late payment successful:", response.reference);
                        completeLateAttendance(response.reference);
                    },
                    onClose: function() {
                        hideLoading();
                        showResult('info', 'Payment Cancelled', 'You cancelled the payment. Please try again when ready.');
                    }
                });
                
                handler.openIframe();
                
            } catch (error) {
                hideLoading();
                console.error('Payment error:', error);
                showResult('error', 'Payment Failed', 'Unable to process payment. Please try again.');
            }
        }
        
        async function completeLateAttendance(paymentReference) {
            showLoading('Recording late attendance...');
            
            try {
                let data;
                try {
                    data = JSON.parse(pendingLateScanData);
                } catch {
                    data = {
                        locationId: 'MAIN-001',
                        department: currentUser.department,
                        locationName: 'Main Office'
                    };
                }
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                
                const record = {
                    id: `late_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    staffId: currentUser.userId,
                    staffName: currentUser.name,
                    department: currentUser.department,
                    location: data.locationName || 'Main Office',
                    type: 'clock_in',
                    date: today,
                    time: timeStr,
                    timestamp: now.getTime(),
                    status: 'late',
                    latePayment: {
                        paid: true,
                        amount: LATE_PAYMENT_AMOUNT,
                        paymentReference: paymentReference,
                        paymentDate: now.toISOString()
                    }
                };
                
                // Save to Firebase
                try {
                    await firebase.database()
                        .ref(`attendance/${today}/${record.id}`)
                        .set(record);
                } catch (fbError) {
                    console.log("Firebase save optional:", fbError.message);
                }
                
                // Save locally
                attendanceRecords.unshift(record);
                saveAttendanceRecords();
                
                // Update UI
                loadAttendanceHistory();
                generateSummaryTable();
                updateTodayStatus();
                
                // Hide banners
                document.getElementById('latePaymentBanner').style.display = 'none';
                closeLatePaymentModal();
                
                hideLoading();
                
                showResult('success', '‚úÖ Late Attendance Recorded', 
                    `You have successfully clocked in (LATE).<br>
                     Time: ${formatTime(now)}<br>
                     Payment: ‚Ç¶${LATE_PAYMENT_AMOUNT} paid<br>
                     Ref: ${paymentReference.substr(0, 12)}...`);
                
                // Clear pending data
                pendingLateScanData = null;
                scanCooldown = false;
                lastScannedCode = null;
                
            } catch (error) {
                hideLoading();
                console.error('Late attendance error:', error);
                showResult('error', 'Recording Failed', 'Unable to record attendance. Please try again.');
            }
        }
        
        // =============================================
        // SERVICE PAYMENT - ACTIVE
        // =============================================
        function showPaymentForm(method) {
            currentPaymentMethod = method;
            document.getElementById('paymentModal').style.display = 'flex';
            
            if (currentUser && currentUser.email) {
                document.getElementById('paystackEmail').value = currentUser.email;
            }
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }
        
        async function processPaystackPayment() {
            const email = document.getElementById('paystackEmail').value.trim();
            
            if (!email) {
                showResult('error', 'Email Required', 'Please enter your email address');
                return;
            }
            
            showLoading('Opening Paystack...');
            
            try {
                const reference = 'NSPM-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8);
                
                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: email,
                    amount: SUBSCRIPTION_PRICE * 100,
                    currency: 'NGN',
                    ref: reference,
                    metadata: {
                        staffId: currentUser.userId,
                        staffName: currentUser.name,
                        paymentType: 'service_activation',
                        timestamp: new Date().toISOString()
                    },
                    callback: function(response) {
                        hideLoading();
                        console.log("‚úÖ Service payment successful:", response.reference);
                        activateService(response.reference);
                    },
                    onClose: function() {
                        hideLoading();
                        showResult('info', 'Payment Cancelled', 'Service activation payment was cancelled.');
                    }
                });
                
                handler.openIframe();
                
            } catch (error) {
                hideLoading();
                console.error('Payment error:', error);
                showResult('error', 'Payment Failed', 'Unable to process payment. Please try again.');
            }
        }
        
        function activateService(paymentReference) {
            // Update user subscription
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 1);
            
            currentUser.subscription = {
                type: 'active',
                status: 'active',
                expiry: expiryDate.toISOString(),
                lastPaymentDate: new Date().toISOString(),
                lastPaymentId: paymentReference,
                paymentAmount: SUBSCRIPTION_PRICE,
                durationMonths: 1
            };
            
            // Update in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].subscription = currentUser.subscription;
                localStorage.setItem('nspm_users', JSON.stringify(users));
            }
            
            // Save current user
            localStorage.setItem('nspm_currentUser', JSON.stringify(currentUser));
            
            // Update UI
            updateServiceStatus();
            enableScanner();
            closePaymentModal();
            
            showResult('success', 'üéâ Service Activated!', 
                `Your attendance service is now active for 30 days.<br>
                 Transaction ID: ${paymentReference.substr(0, 16)}...`);
        }
        
        // =============================================
        // UI UPDATE FUNCTIONS
        // =============================================
        function updateTodayStatus() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(r => 
                r.staffId === currentUser.userId && r.date === today
            );
            
            const clockIn = todayRecords.find(r => r.type === 'clock_in');
            const clockOut = todayRecords.find(r => r.type === 'clock_out');
            
            document.getElementById('todayStatus').textContent = 
                !clockIn ? 'Not Clocked' : 
                clockIn && !clockOut ? 'Clocked In' : 'Clocked Out';
            
            document.getElementById('todayStatus').className = 
                !clockIn ? 'clock-status-value' :
                clockIn && !clockOut ? 'clock-status-value clocked-in' : 'clock-status-value clocked-out';
            
            document.getElementById('lastClockIn').textContent = 
                clockIn ? formatTime(clockIn.time) : '--:--';
            
            document.getElementById('lastClockOut').textContent = 
                clockOut ? formatTime(clockOut.time) : '--:--';
        }
        
        function generateSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            if (!tbody) return;
            
            // Group by date
            const recordsByDate = {};
            attendanceRecords
                .filter(r => r.staffId === currentUser.userId)
                .forEach(r => {
                    if (!recordsByDate[r.date]) {
                        recordsByDate[r.date] = { clockIn: null, clockOut: null, status: 'on_time' };
                    }
                    if (r.type === 'clock_in') {
                        recordsByDate[r.date].clockIn = r;
                        if (r.status === 'late') recordsByDate[r.date].status = 'late';
                    } else {
                        recordsByDate[r.date].clockOut = r;
                    }
                });
            
            const dates = Object.keys(recordsByDate).sort().reverse();
            
            if (dates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No attendance records found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            dates.forEach(date => {
                const day = recordsByDate[date];
                
                let hours = '--';
                if (day.clockIn && day.clockOut) {
                    const inTime = new Date(`${date}T${day.clockIn.time}`);
                    const outTime = new Date(`${date}T${day.clockOut.time}`);
                    const diff = (outTime - inTime) / (1000 * 60 * 60);
                    hours = diff.toFixed(1);
                }
                
                let status = '--';
                let statusClass = '';
                
                if (day.clockIn) {
                    if (day.status === 'late') {
                        status = 'Late (Paid)';
                        statusClass = 'status-paid-late';
                    } else {
                        status = 'On Time';
                        statusClass = 'status-on-time';
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(date)}</td>
                    <td>${day.clockIn ? formatTime(day.clockIn.time) : '--:--'}</td>
                    <td>${day.clockOut ? formatTime(day.clockOut.time) : '--:--'}</td>
                    <td>${hours}h</td>
                    <td class="${statusClass}">${status}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function loadAttendanceHistory() {
            const tbody = document.getElementById('attendanceTableBody');
            if (!tbody) return;
            
            const dateFilter = document.getElementById('dateFilter')?.value || '';
            const typeFilter = document.getElementById('typeFilter')?.value || '';
            const lateFilter = document.getElementById('lateFilter')?.value || '';
            
            let filtered = attendanceRecords
                .filter(r => r.staffId === currentUser.userId)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (dateFilter) {
                filtered = filtered.filter(r => r.date === dateFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(r => r.type === typeFilter);
            }
            
            if (lateFilter === 'late') {
                filtered = filtered.filter(r => r.status === 'late');
            } else if (lateFilter === 'on_time') {
                filtered = filtered.filter(r => r.status === 'on_time' || !r.status);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No attendance records found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filtered.forEach(record => {
                const row = document.createElement('tr');
                
                let typeText = record.type === 'clock_in' ? 'Clock In' : 'Clock Out';
                let statusText = 'On Time';
                let statusClass = 'status-on-time';
                
                if (record.type === 'clock_in') {
                    if (record.status === 'late') {
                        typeText = 'Clock In (Late)';
                        statusText = 'Late (Paid)';
                        statusClass = 'status-paid-late';
                    }
                }
                
                const paymentRef = record.latePayment?.paymentReference 
                    ? record.latePayment.paymentReference.substr(0, 8) + '...' 
                    : '-';
                
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td class="${statusClass}">${typeText}</td>
                    <td>${formatTime(record.time)}</td>
                    <td>${record.department || currentUser.department}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${paymentRef}</td>
                    <td class="action-cell">
                        <button class="delete-record-btn" onclick="deleteAttendanceRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function filterAttendanceHistory() {
            loadAttendanceHistory();
        }
        
        function deleteAttendanceRecord(recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
                attendanceRecords = attendanceRecords.filter(r => r.id !== recordId);
                saveAttendanceRecords();
                loadAttendanceHistory();
                generateSummaryTable();
                updateTodayStatus();
                showResult('success', 'Record Deleted', 'Attendance record has been removed');
            }
        }
        
        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch {
                return dateStr;
            }
        }
        
        function formatTime(timeStr) {
            try {
                if (timeStr.includes(':')) {
                    return timeStr;
                }
                const date = new Date(timeStr);
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true
                });
            } catch {
                return timeStr;
            }
        }
        
        function showLoading(message = 'Processing...') {
            const overlay = document.getElementById('loadingOverlay');
            const msg = document.getElementById('loadingMessage');
            msg.textContent = message;
            overlay.style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showResult(type, title, message) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            const icon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            
            content.className = '';
            if (type === 'success') {
                content.classList.add('result-success');
                icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i>';
            } else if (type === 'error') {
                content.classList.add('result-error');
                icon.innerHTML = '<i class="fas fa-times-circle" style="color: var(--danger);"></i>';
            } else if (type === 'warning') {
                icon.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: var(--late);"></i>';
            } else {
                icon.innerHTML = '<i class="fas fa-info-circle" style="color: var(--primary);"></i>';
            }
            
            resultTitle.textContent = title;
            resultMessage.innerHTML = message;
            
            modal.style.display = 'flex';
        }
        
        function closeResult() {
            document.getElementById('resultModal').style.display = 'none';
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                stopScanner();
                firebase.auth().signOut().catch(() => {});
                localStorage.removeItem('nspm_currentUser');
                currentUser = null;
                showAuth();
                showResult('success', 'Logged Out', 'You have been successfully logged out');
            }
        }
        
        // =============================================
        // EVENT LISTENERS
        // =============================================
        function setupEventListeners() {
            // Login toggle
            document.getElementById('loginToggle').addEventListener('click', showLoginForm);
            document.getElementById('signupToggle').addEventListener('click', showSignupForm);
            
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
            document.getElementById('signupForm').addEventListener('submit', (e) => { e.preventDefault(); handleSignup(); });
            document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => { e.preventDefault(); showLoginForm(); });
            
            // Links
            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); showForgotPasswordForm(); });
            document.getElementById('backToLoginLink').addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Clear cache
            document.getElementById('clearCacheLink').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Clear all cached data? You will need to login again.')) {
                    localStorage.clear();
                    sessionStorage.clear();
                    location.reload();
                }
            });
        }
        
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('themeToggle').innerHTML = isLight ? 
                '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('nspm_theme', isLight ? 'light' : 'dark');
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Special handling
            if (tabName === 'scanner') {
                if (!isScannerActive) {
                    if (canUserScan()) {
                        enableScanner();
                    }
                }
            } else {
                stopScanner();
            }
            
            if (tabName === 'history') {
                loadAttendanceHistory();
                generateSummaryTable();
            }
        }

        // Make functions globally accessible
        window.startScanner = startScanner;
        window.stopScanner = stopScanner;
        window.switchTab = switchTab;
        window.showPaymentForm = showPaymentForm;
        window.closePaymentModal = closePaymentModal;
        window.processPaystackPayment = processPaystackPayment;
        window.showLatePaymentModal = showLatePaymentModal;
        window.closeLatePaymentModal = closeLatePaymentModal;
        window.processLatePayment = processLatePayment;
        window.cancelLateAttendance = cancelLateAttendance;
        window.filterAttendanceHistory = filterAttendanceHistory;
        window.deleteAttendanceRecord = deleteAttendanceRecord;
        window.logout = logout;
        window.closeResult = closeResult;
    </script>
</body>
</html>
